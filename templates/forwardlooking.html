{% extends 'base.html' %}
{% import 'boxes.html' as boxes %}
{% block content %}
    <ul class="list-inline" style="padding: 1em">
        <li><a href="#h_table">Table</a></li>
        <li>|</li>
        <!--<li><a href="#h_summary">Summary</a></li>
        <li>|</li>
        <li><a href="#h_narrative">Narrative</a></li>
        <li>|</li>
        <li><a href="#h_assesment">Assessment</a></li>
        <li>|</li>
        <li><a href="#h_exceptions">Exceptions</a></li>
        <li>|</li>
        <li><a href="#h_comparison">Comparison with Global Partnership Indicator methodology</a></li>
        <li>|</li>-->
        <li><a href="#h_comment">Comment</a><li>
        <li>|</li>
        <li><a href="#h_pseudocode">Pseudocode</a></li>
    </ul>

    <table class="table table-striped" id="main_table">
        <thead>
            <tr>
                <td></td>
                <td colspan="3" style="border-left: 1px solid gray;">Current activities</td>
                <td colspan="3" style="border-left: 1px solid gray;">Activities with budgets</td>
                <td colspan="3" style="border-left: 1px solid gray;">Percentage of activities with budgets</td>
            </tr>
            <tr>
                <td>Publisher Name</td>
                {% for i in range(0,3) %}
                {% for year in years %}
                <td{% if loop.first %} style="border-left: 1px solid gray;"{% endif %}>{{year}}</td>
                {% endfor %}
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for publisher_title,publisher in publishers_ordered_by_title %}
            {% set publisher_stats = get_publisher_stats(publisher) %}
            <tr>
                <td><a href="publisher/{{publisher}}.html">{{publisher_title}}</a></td>

                {% for year in years %}
                    <td{% if loop.first %} style="border-left: 1px solid gray;"{% endif %}>
                        {{publisher_stats.forwardlooking_activities_current[year]}}
                    </td>
                {% endfor %}

                {% for year in years %}
                    <td{% if loop.first %} style="border-left: 1px solid gray;"{% endif %}>
                        {{publisher_stats.forwardlooking_activities_with_budgets[year]}}
                    </td>
                {% endfor %}

                {% for year in years %}
                    <td{% if loop.first %} style="border-left: 1px solid gray;"{% endif %}>
                        {% if not publisher_stats.forwardlooking_activities_current.get(year) %}-{%else%}{{(publisher_stats.forwardlooking_activities_with_budgets[year]/publisher_stats.forwardlooking_activities_current[year]*100)|round|int}}{%endif%}
                    </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>



    <div class="panel panel-default" id="h_comment">
    <div class="panel-heading">
        <h3 class="panel-title">Comment</h3>
    </div>
    <div class="panel-body">
        <p>To comment on this methodology, please use <a href="http://support.iatistandard.org/entries/61004309-Forward-looking">this page on the support forum</a>.</p>
    </div>
    </div>



    <div class="panel panel-default" id="h_pseudocode">
    <div class="panel-heading">
        <h3 class="panel-title">Pseudocode</h3>
    </div>
    <div class="panel-body">

    <p>To test whether an activity is current in a given year:</p>

<pre>
For each activity-date of type end-planned or end-actual
    date =
        Parse activity-date/@iso-date as an iso date ('yyyy-mm-dd...')
        If this does not work parse activity-date/text() as an iso date ('yyyy-mm-dd...')
        If neither work, continue
    If date year >= given year
        The activity is current
    Else continue
Otherwise the activity is not current
</pre>

    <p>To find the year for a budget:</p>

<pre>
start = 
    Parse period-start/@iso-date as an iso date ('yyyy-mm-dd...')
    If this does not work parse period-start/text() as an iso date ('yyyy-mm-dd...')
    Otherwise null
end =
    Parse period-start/@iso-date as an iso date ('yyyy-mm-dd...')
    If this does not work parse period-start/text() as an iso date ('yyyy-mm-dd...')
    Otherwise null

If start and end are both not null 
    If (end - start <= 370 days)
        If end month >= 7
            budget year = end year
        Else
            budget year = end year - 1
    Else ignore the budget
Else budget year is null
</pre>
    
    <p>To calculate the "Current activities" column, count each activity that is current (as described above).</p>
    <p>To calculate the "Activities with budgets" column, count the number of current activities that are:
        <ul>
        <li>current</li>
        <li>AND contain at least one budget budget with a budget year (as desribed above) that matches the year of the column</p>
        </ul>
    </p>

    </div>
    </div>
{% endblock %}

{% block tablesorteroptions %}{
    widgets: ['stickyHeaders'],
    textExtraction:{
        7: function(node,table,cellIndex) {
            if ($(node).text().indexOf('-') > 0) return '0';
            else return $(node).text();
        },
        8: function(node,table,cellIndex) {
            if ($(node).text().indexOf('-') > 0) return '0';
            else return $(node).text();
        },
        9: function(node,table,cellIndex) {
            if ($(node).text().indexOf('-') > 0) return '0';
            else return $(node).text();
        }
    }
}{% endblock %}
{% block tablesortertarget %}table#main_table{% endblock %}

